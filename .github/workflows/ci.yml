name: CI/CD Pipeline - MacroMuse Architecture Enforcement

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  architectural-validation:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Architectural Validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: ğŸ” TypeScript Strict Check
      run: npm run type-check

    - name: ğŸš¨ ESLint Architectural Rules (ZERO warnings allowed)
      run: npm run lint

    - name: ğŸ§± Check Cross-Store Import Violations
      run: |
        echo "Checking for cross-store imports..."
        if grep -r "import.*\.\./state/" app/ 2>/dev/null; then
          echo "âŒ ARCHITECTURAL VIOLATION: Cross-store imports detected"
          echo "Use eventBus for cross-store communication"
          exit 1
        fi
        echo "âœ… No cross-store import violations found"

    - name: ğŸ¯ Check UIâ†’Domain Direct Import Violations
      run: |
        echo "Checking for UI importing domain directly..."
        if grep -r "import.*domain.*" app/ui/ 2>/dev/null | grep -v "@domain"; then
          echo "âŒ ARCHITECTURAL VIOLATION: UI importing domain directly"
          echo "Use facades for domain access"
          exit 1
        fi
        echo "âœ… No UIâ†’Domain direct import violations found"

    - name: ğŸ“ Check File Size Violations (>400 lines)
      run: |
        echo "Checking for files exceeding 400 lines..."
        violations=$(find app/ -name "*.ts" -o -name "*.tsx" | xargs wc -l | awk '$1 > 400 { print $2 ": " $1 " lines" }')
        if [ -n "$violations" ]; then
          echo "âŒ ARCHITECTURAL VIOLATION: Files exceeding 400 lines:"
          echo "$violations"
          exit 1
        fi
        echo "âœ… All files within 400 line limit"

    - name: ğŸ§ª Run Unit Tests (when available)
      run: npm run test:unit || echo "Unit tests not configured yet"

    - name: ğŸ“Š Validate Performance Budget Setup
      run: |
        echo "Checking performance budget configuration..."
        if [ -f "app/lib/performance.ts" ]; then
          echo "âœ… Performance budgets configured"
        else
          echo "âš ï¸ Performance budgets not yet configured"
        fi

  build-validation:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build Validation
    needs: architectural-validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build with Expo
      run: npx expo export --platform web

    - name: ğŸ“± Validate React Native Bundle
      run: |
        echo "Validating React Native configuration..."
        if [ -f "metro.config.js" ] || [ -f "metro.config.ts" ]; then
          echo "âœ… Metro config present"
        else
          echo "âš ï¸ Using default Metro config"
        fi

  security-audit:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Audit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: ğŸ” npm audit
      run: npm audit --audit-level moderate

    - name: ğŸ—ï¸ Check for secrets in code
      run: |
        echo "Checking for potential secrets..."
        if grep -r -E "(api_key|apikey|secret|password|token)" app/ --include="*.ts" --include="*.tsx" | grep -v -E "(example|test|mock|placeholder)"; then
          echo "âŒ Potential secrets found in code"
          echo "Move secrets to environment variables"
          exit 1
        fi
        echo "âœ… No hardcoded secrets detected"

  foundation-compliance:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Foundation Document Compliance
    needs: architectural-validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ğŸ›ï¸ Validate Foundation Architecture
      run: |
        echo "Validating Foundation document compliance..."

        # Check required directories exist
        required_dirs=("app/app" "app/ui" "app/domain" "app/infra" "app/data" "app/state" "app/lib" "app/tests")
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ Required directory missing: $dir"
            exit 1
          fi
        done
        echo "âœ… All required directories present"

        # Check domain models exist
        if [ ! -f "app/domain/models.ts" ]; then
          echo "âŒ Domain models missing: app/domain/models.ts"
          exit 1
        fi
        echo "âœ… Domain models present"

        # Check event bus exists
        if [ ! -f "app/lib/eventBus.ts" ]; then
          echo "âŒ Event bus missing: app/lib/eventBus.ts"
          exit 1
        fi
        echo "âœ… Event bus present"

        # Check feature flags exist
        if [ ! -f "app/lib/featureFlags.ts" ]; then
          echo "âŒ Feature flags missing: app/lib/featureFlags.ts"
          exit 1
        fi
        echo "âœ… Feature flags present"

        # Check stores exist and are properly named
        stores=("appStore" "dataStore" "uiStore")
        for store in "${stores[@]}"; do
          if [ ! -f "app/state/${store}.ts" ]; then
            echo "âŒ Required store missing: app/state/${store}.ts"
            exit 1
          fi
        done
        echo "âœ… All required stores present"

        echo "ğŸ‰ Foundation document compliance validated!"